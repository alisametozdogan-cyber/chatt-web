<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>ðŸ”¥ Chatt Web 2.0</title>
<style>
  body { font-family: Arial; background:#1c1c1c; color:white; margin:0; padding:0; }
  h2 { text-align:center; margin-top:20px; }
  #container { display:flex; justify-content:center; margin-top:20px; gap:20px; }
  #chat-container { background:#222; padding:15px; border-radius:10px; width:400px; max-height:500px; overflow-y:auto; }
  #chat-container p { background:#333; padding:8px 10px; border-radius:5px; margin:5px 0; display:flex; justify-content:space-between; align-items:center; }
  #chat-container button { background:#ff4d4d; border:none; color:white; border-radius:5px; padding:2px 6px; cursor:pointer; }
  #chat-container button:hover { background:#ff1a1a; }
  #input-container { margin-top:10px; display:flex; flex-direction:column; gap:10px; }
  input { padding:8px 10px; border-radius:5px; border:none; width:100%; box-sizing:border-box; }
  button#send, button#voiceBtn { background:#4caf50; border:none; color:white; padding:10px; border-radius:5px; cursor:pointer; }
  button#send:hover, button#voiceBtn:hover { background:#45a049; }
  audio { margin-top:10px; width:100%; border-radius:5px; }
</style>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
</head>
<body>

<h2>ðŸ”¥ Chatt Web 2.0</h2>

<div id="container">
  <div id="chat-container">
    <div id="chat"></div>
    <div id="input-container">
      <input id="username" placeholder="KullanÄ±cÄ± AdÄ±">
      <input id="message" placeholder="Mesaj yaz...">
      <button id="send">GÃ¶nder</button>
      <button id="voiceBtn">Mikrofonu AÃ§</button>
      <audio id="remoteAudio" autoplay></audio>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

// Firebase ayarlarÄ±
const firebaseConfig = {
  apiKey: "AIzaSyBhZF2igk9MZF-UEVYQEJl9N6IhMAeRsLU",
  authDomain: "chatt-5c23d.firebaseapp.com",
  databaseURL: "https://chatt-5c23d-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chatt-5c23d",
  storageBucket: "chatt-5c23d.firebasestorage.app",
  messagingSenderId: "307426902187",
  appId: "1:307426902187:web:6bb314fe10261a1733b7ee"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Chat fonksiyonlarÄ±
window.sendMessage = function() {
  const username = document.getElementById("username").value.trim();
  const message = document.getElementById("message").value.trim();
  if(username && message){
    push(ref(db, "messages"), { user: username, text: message });
    document.getElementById("message").value = "";
  }
}

window.deleteMessage = function(mesajId){
  remove(ref(db, "messages/" + mesajId))
    .then(() => console.log("Mesaj silindi"))
    .catch(err => console.error("Hata: ", err));
}

onChildAdded(ref(db, "messages"), (data) => {
  const msg = data.val();
  const id = data.key;
  const chatDiv = document.getElementById("chat");
  const p = document.createElement("p");
  p.innerHTML = `<span><b>${msg.user}:</b> ${msg.text}</span> <button onclick="deleteMessage('${id}')">Sil</button>`;
  chatDiv.appendChild(p);
  chatDiv.scrollTop = chatDiv.scrollHeight;
});

// Sesli Sohbet Basit (Her kullanÄ±cÄ± kendi sesi)
let localStream, pc;
const remoteAudio = document.getElementById("remoteAudio");
const voiceBtn = document.getElementById("voiceBtn");

voiceBtn.onclick = async () => {
  if(!localStream){
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    startCall();
    voiceBtn.innerText = "Mikrofonu Kapat";
  } else {
    localStream.getTracks().forEach(track => track.stop());
    if(pc) pc.close();
    localStream = null;
    pc = null;
    voiceBtn.innerText = "Mikrofonu AÃ§";
  }
};

function startCall(){
  pc = new RTCPeerConnection();
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  pc.ontrack = event => { remoteAudio.srcObject = event.streams[0]; };

  const callRef = ref(db, "voiceCall");

  pc.onicecandidate = event => {
    if(event.candidate) push(callRef, event.candidate.toJSON());
  };

  onChildAdded(callRef, snapshot => {
    const data = snapshot.val();
    if(data && data.candidate) pc.addIceCandidate(new RTCIceCandidate(data.candidate));
  });

  pc.createOffer().then(offer => {
    pc.setLocalDescription(offer);
  });
}

// Event listeners
document.getElementById("send").addEventListener("click", sendMessage);

</script>

</body>
</html>
