class TinyTeamGame {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.currentScreen = 'menu';
        this.roomCode = null;
        this.playerId = this.generatePlayerId();
        this.playerName = '';
        this.players = {};
        this.gameState = 'waiting';
        this.currentLevel = 1;
        this.levels = this.createLevels();
        
        this.initializeEventListeners();
        this.initializeGame();
    }

    generatePlayerId() {
        return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    generateRoomCode() {
        return Math.random().toString(36).substr(2, 6).toUpperCase();
    }

    initializeEventListeners() {
        // MenÃ¼ event listeners
        document.getElementById('createRoomBtn').addEventListener('click', () => this.createRoom());
        document.getElementById('joinRoomBtn').addEventListener('click', () => this.joinRoom());
        document.getElementById('startGameBtn').addEventListener('click', () => this.startGame());
        document.getElementById('leaveLobbyBtn').addEventListener('click', () => this.leaveLobby());
        document.getElementById('resetLevelBtn').addEventListener('click', () => this.resetLevel());
        document.getElementById('backToLobbyBtn').addEventListener('click', () => this.backToLobby());

        // Klavye kontrolleri
        document.addEventListener('keydown', (e) => this.handleKeyDown(e));
        document.addEventListener('keyup', (e) => this.handleKeyUp(e));

        // Touch kontrolleri (mobil)
        this.canvas.addEventListener('touchstart', (e) => this.handleTouch(e));
    }

    async createRoom() {
        const playerName = document.getElementById('playerName').value.trim();
        if (!playerName) {
            alert('LÃ¼tfen isminizi girin!');
            return;
        }

        this.playerName = playerName;
        this.roomCode = this.generateRoomCode();

        try {
            await roomsRef.child(this.roomCode).set({
                host: this.playerId,
                gameState: 'waiting',
                currentLevel: 1,
                created: firebase.database.ServerValue.TIMESTAMP
            });

            await this.joinRoomAsPlayer();
            this.showLobby();
        } catch (error) {
            console.error('Oda oluÅŸturulamadÄ±:', error);
            alert('Oda oluÅŸturulamadÄ±!');
        }
    }

    async joinRoom() {
        const playerName = document.getElementById('playerName').value.trim();
        const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
        
        if (!playerName || !roomCode) {
            alert('Ä°sim ve oda kodunu girin!');
            return;
        }

        try {
            const roomSnapshot = await roomsRef.child(roomCode).once('value');
            if (!roomSnapshot.exists()) {
                alert('Oda bulunamadÄ±!');
                return;
            }

            this.playerName = playerName;
            this.roomCode = roomCode;
            await this.joinRoomAsPlayer();
            this.showLobby();
        } catch (error) {
            console.error('Odaya katÄ±lamadÄ±:', error);
            alert('Odaya katÄ±lamadÄ±!');
        }
    }

    async joinRoomAsPlayer() {
        const playerColor = this.getRandomColor();
        
        await playersRef.child(this.roomCode).child(this.playerId).set({
            name: this.playerName,
            color: playerColor,
            x: 100,
            y: 400,
            vx: 0,
            vy: 0,
            grounded: false,
            alive: true,
            joined: firebase.database.ServerValue.TIMESTAMP
        });

        // Oyuncu listesini dinle
        playersRef.child(this.roomCode).on('value', (snapshot) => {
            this.players = snapshot.val() || {};
            this.updatePlayersDisplay();
        });

        // Oda durumunu dinle
        roomsRef.child(this.roomCode).on('value', (snapshot) => {
            const roomData = snapshot.val();
            if (roomData) {
                if (roomData.gameState === 'playing' && this.currentScreen === 'lobby') {
                    this.showGame();
                    this.startGameLoop();
                }
            }
        });
    }

    showLobby() {
        this.currentScreen = 'lobby';
        document.querySelector('.screen.active').classList.remove('active');
        document.getElementById('lobbyScreen').classList.add('active');
        document.getElementById('currentRoomCode').textContent = this.roomCode;
    }

    showGame() {
        this.currentScreen = 'game';
        document.querySelector('.screen.active').classList.remove('active');
        document.getElementById('gameScreen').classList.add('active');
        this.initializeGame();
    }

    updatePlayersDisplay() {
        const container = document.getElementById('playersContainer');
        container.innerHTML = '';

        Object.entries(this.players).forEach(([id, player]) => {
            const playerDiv = document.createElement('div');
            playerDiv.className = 'player-item';
            playerDiv.innerHTML = `
                <span class="player-colors" style="background-color: ${player.color}"></span>
                ${player.name}
            `;
            container.appendChild(playerDiv);
        });

        document.getElementById('aliveCount').textContent = Object.keys(this.players).length;
    }

    async startGame() {
        try {
            await roomsRef.child(this.roomCode).update({
                gameState: 'playing'
            });
        } catch (error) {
            console.error('Oyun baÅŸlatÄ±lamadÄ±:', error);
        }
    }

    createLevels() {
        return [
            {
                // Seviye 1 - Basit platform
                platforms: [
                    { x: 0, y: 580, width: 800, height: 20 }, // Zemin
                    { x: 200, y: 450, width: 200, height: 20 },
                    { x: 500, y: 320, width: 200, height: 20 }
                ],
                goal: { x: 650, y: 250, width: 50, height: 50 },
                spikes: [],
                switches: []
            },
            {
                // Seviye 2 - Ä°ÅŸbirliÄŸi gereken platform
                platforms: [
                    { x: 0, y: 580, width: 800, height: 20 },
                    { x: 100, y: 450, width: 100, height: 20 },
                    { x: 300, y: 350, width: 200, height: 20 },
                    { x: 600, y: 250, width: 100, height: 20 }
                ],
                goal: { x: 625, y: 180, width: 50, height: 50 },
                spikes: [
                    { x: 250, y: 560, width: 100, height: 20 }
                ],
                switches: [
                    { x: 150, y: 430, width: 30, height: 20, required: 2 }
                ]
            }
        ];
    }

    initializeGame() {
        this.keys = {};
        
        // Oyuncuyu spawn noktasÄ±na yerleÅŸtir
        if (this.players[this.playerId]) {
            this.players[this.playerId].x = 50;
            this.players[this.playerId].y = 500;
            this.players[this.playerId].vx = 0;
            this.players[this.playerId].vy = 0;
            this.players[this.playerId].alive = true;
        }
    }

    startGameLoop() {
        this.gameLoop = setInterval(() => {
            this.update();
            this.render();
        }, 1000 / 60); // 60 FPS
    }

    update() {
        if (this.currentScreen !== 'game') return;

        const player = this.players[this.playerId];
        if (!player || !player.alive) return;

        // Fizik gÃ¼ncelleme
        this.updatePhysics(player);
        
        // Ã‡arpÄ±ÅŸma kontrolÃ¼
        this.checkCollisions(player);
        
        // Oyuncu pozisyonunu Firebase'e gÃ¶nder
        this.updatePlayerPosition();
    }

    updatePhysics(player) {
        // YerÃ§ekimi
        if (!player.grounded) {
            player.vy += 0.8;
        }

        // Hareket kontrolleri
        if (this.keys['ArrowLeft'] || this.keys['a'] || this.keys['A']) {
            player.vx = -5;
        } else if (this.keys['ArrowRight'] || this.keys['d'] || this.keys['D']) {
            player.vx = 5;
        } else {
            player.vx *= 0.8; // SÃ¼rtÃ¼nme
        }

        // ZÄ±plama
        if ((this.keys['ArrowUp'] || this.keys['w'] || this.keys['W'] || this.keys[' ']) && player.grounded) {
            player.vy = -15;
            player.grounded = false;
        }

        // Pozisyon gÃ¼ncelleme
        player.x += player.vx;
        player.y += player.vy;

        // Ekran sÄ±nÄ±rlarÄ±
        if (player.x < 0) player.x = 0;
        if (player.x > this.canvas.width - 30) player.x = this.canvas.width - 30;
        if (player.y > this.canvas.height) {
            this.respawnPlayer();
        }
    }

    checkCollisions(player) {
        const level = this.levels[this.currentLevel - 1];
        player.grounded = false;

        // Platform Ã§arpÄ±ÅŸmalarÄ±
        level.platforms.forEach(platform => {
            if (this.checkRectCollision(player, platform)) {
                // Ãœstten Ã§arpÄ±ÅŸma (platform Ã¼zerinde durma)
                if (player.vy > 0 && player.y < platform.y) {
                    player.y = platform.y - 30;
                    player.vy = 0;
                    player.grounded = true;
                }
                // Alttan Ã§arpÄ±ÅŸma
                else if (player.vy < 0 && player.y > platform.y) {
                    player.y = platform.y + platform.height;
                    player.vy = 0;
                }
                // Yanlardan Ã§arpÄ±ÅŸma
                else {
                    if (player.vx > 0) {
                        player.x = platform.x - 30;
                    } else {
                        player.x = platform.x + platform.width;
                    }
                    player.vx = 0;
                }
            }
        });

        // Diken Ã§arpÄ±ÅŸmalarÄ±
        level.spikes.forEach(spike => {
            if (this.checkRectCollision(player, spike)) {
                this.killPlayer();
            }
        });

        // Hedef Ã§arpÄ±ÅŸmasÄ±
        if (this.checkRectCollision(player, level.goal)) {
            this.completeLevel();
        }
    }

    checkRectCollision(rect1, rect2) {
        return rect1.x < rect2.x + rect2.width &&
               rect1.x + 30 > rect2.x &&
               rect1.y < rect2.y + rect2.height &&
               rect1.y + 30 > rect2.y;
    }

    render() {
        if (this.currentScreen !== 'game') return;

        // EkranÄ± temizle
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        const level = this.levels[this.currentLevel - 1];

        // PlatformlarÄ± Ã§iz
        this.ctx.fillStyle = '#8B4513';
        level.platforms.forEach(platform => {
            this.ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
        });

        // Dikenleri Ã§iz
        this.ctx.fillStyle = '#FF4500';
        level.spikes.forEach(spike => {
            this.ctx.fillRect(spike.x, spike.y, spike.width, spike.height);
        });

        // Hedefi Ã§iz
        this.ctx.fillStyle = '#FFD700';
        this.ctx.fillRect(level.goal.x, level.goal.y, level.goal.width, level.goal.height);
        
        // Hedef Ã¼zerinde star sembolÃ¼
        this.ctx.fillStyle = '#FF6347';
        this.ctx.font = '30px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.fillText('â˜…', level.goal.x + 25, level.goal.y + 35);

        // OyuncularÄ± Ã§iz
        Object.entries(this.players).forEach(([id, player]) => {
            if (player.alive) {
                this.ctx.fillStyle = player.color;
                this.ctx.fillRect(player.x, player.y, 30, 30);
                
                // Oyuncu ismi
                this.ctx.fillStyle = '#000';
                this.ctx.font = '12px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(player.name, player.x + 15, player.y - 5);
            }
        });
    }

    async updatePlayerPosition() {
        const player = this.players[this.playerId];
        if (player) {
            try {
                await playersRef.child(this.roomCode).child(this.playerId).update({
                    x: player.x,
                    y: player.y,
                    vx: player.vx,
                    vy: player.vy,
                    grounded: player.grounded,
                    alive: player.alive
                });
            } catch (error) {
                console.error('Pozisyon gÃ¼ncellenemedi:', error);
            }
        }
    }

    handleKeyDown(e) {
        this.keys[e.code] = true;
        this.keys[e.key] = true;
        e.preventDefault();
    }

    handleKeyUp(e) {
        this.keys[e.code] = false;
        this.keys[e.key] = false;
        e.preventDefault();
    }

    handleTouch(e) {
        e.preventDefault();
        const rect = this.canvas.getBoundingClientRect();
        const touchX = e.touches[0].clientX - rect.left;
        const touchY = e.touches[0].clientY - rect.top;

        // Basit touch kontrolleri
        if (touchX < this.canvas.width / 3) {
            this.keys['ArrowLeft'] = true;
            setTimeout(() => this.keys['ArrowLeft'] = false, 100);
        } else if (touchX > this.canvas.width * 2 / 3) {
            this.keys['ArrowRight'] = true;
            setTimeout(() => this.keys['ArrowRight'] = false, 100);
        } else {
            this.keys[' '] = true;
            setTimeout(() => this.keys[' '] = false, 100);
        }
    }

    respawnPlayer() {
        const player = this.players[this.playerId];
        if (player) {
            player.x = 50;
            player.y = 500;
            player.vx = 0;
            player.vy = 0;
            player.alive = true;
        }
    }

    killPlayer() {
        const player = this.players[this.playerId];
        if (player) {
            player.alive = false;
            setTimeout(() => this.respawnPlayer(), 1000);
        }
    }

    async completeLevel() {
        alert('Seviye tamamlandÄ±! ðŸŽ‰');
        
        if (this.currentLevel < this.levels.length) {
            this.currentLevel++;
            document.getElementById('currentLevel').textContent = this.currentLevel;
            this.respawnPlayer();
        } else {
            alert('TÃ¼m seviyeler tamamlandÄ±! ðŸ†');
            this.backToLobby();
        }
    }

    async resetLevel() {
        Object.keys(this.players).forEach(playerId => {
            if (this.players[playerId]) {
                this.players[playerId].x = 50;
                this.players[playerId].y = 500;
                this.players[playerId].vx = 0;
                this.players[playerId].vy = 0;
                this.players[playerId].alive = true;
            }
        });
    }

    async backToLobby() {
        if (this.gameLoop) {
            clearInterval(this.gameLoop);
        }
        
        try {
            await roomsRef.child(this.roomCode).update({
                gameState: 'waiting'
            });
        } catch (error) {
            console.error('Lobby\'e dÃ¶nÃ¼lemedi:', error);
        }
        
        this.showLobby();
    }

    async leaveLobby() {
        try {
            await playersRef.child(this.roomCode).child(this.playerId).remove();
        } catch (error) {
            console.error('Odadan Ã§Ä±kÄ±lamadÄ±:', error);
        }
        
        // Ana menÃ¼ye dÃ¶n
        this.currentScreen = 'menu';
        document.querySelector('.screen.active').classList.remove('active');
        document.getElementById('menuScreen').classList.add('active');
        
        // Temizlik
        this.roomCode = null;
        this.players = {};
        if (this.gameLoop) {
            clearInterval(this.gameLoop);
        }
    }

    getRandomColor() {
        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
        return colors[Math.floor(Math.random() * colors.length)];
    }
}

// Oyunu baÅŸlat
document.addEventListener('DOMContentLoaded', () => {
    new TinyTeamGame();
});
