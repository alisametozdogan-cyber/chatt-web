<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Mini Pico Park Multiplayer</title>
<style>
body { margin:0; font-family:sans-serif; background:#222; color:white; display:flex; flex-direction:column; align-items:center; }
canvas { background:#333; margin-top:10px; border:2px solid #555; }
#loginModal, #roomModal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:flex; justify-content:center; align-items:center; z-index:999; }
.modal-content { background:#444; padding:20px; border-radius:10px; display:flex; flex-direction:column; gap:10px; }
button { cursor:pointer; }
#leaderboard { margin-top:10px; width:400px; background:#2f2f2f; padding:10px; border-radius:8px; }
#roomsList { margin-top:10px; background:#2f2f2f; padding:10px; border-radius:8px; width:300px; }
.roomItem { padding:5px; background:#555; margin:5px 0; border-radius:5px; cursor:pointer; }
.roomItem:hover { background:#7289da; }
</style>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
</head>
<body>

<div id="loginModal">
  <div class="modal-content">
    <h3>Giriş / Kayıt</h3>
    <input id="loginUsername" placeholder="Kullanıcı adı">
    <input id="loginNickname" placeholder="Nickname">
    <input id="loginAvatar" placeholder="Avatar URL (opsiyonel)">
    <button id="loginBtn">Giriş Yap</button>
  </div>
</div>

<div id="roomModal" style="display:none;">
  <div class="modal-content">
    <h3>Oda Kur / Odaya Katıl</h3>
    <button id="createRoomBtn">Oda Kur</button>
    <div id="roomsList"></div>
  </div>
</div>

<canvas id="gameCanvas" width="600" height="400"></canvas>
<div id="leaderboard"><h4>Leaderboard</h4><ul id="scores"></ul></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBhZF2igk9MZF-UEVYQEJl9N6IhMAeRsLU",
  authDomain: "chatt-5c23d.firebaseapp.com",
  databaseURL: "https://chatt-5c23d-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chatt-5c23d",
  storageBucket: "chatt-5c23d.appspot.com",
  messagingSenderId: "307426902187",
  appId: "1:307426902187:web:6bb314fe10261a1733b7ee"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let username="", nickname="", avatar="https://i.pravatar.cc/40";
let roomId = "";
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const loginModal = document.getElementById("loginModal");
const roomModal = document.getElementById("roomModal");
const roomsListDiv = document.getElementById("roomsList");
const leaderboardUl = document.getElementById("scores");

let players = {};
let scores = {};
const keys={};

// Login
document.getElementById("loginBtn").onclick = ()=>{
  username = document.getElementById("loginUsername").value.trim();
  nickname = document.getElementById("loginNickname").value.trim();
  avatar = document.getElementById("loginAvatar").value.trim() || avatar;
  if(!username || !nickname) return alert("Zorunlu alanlar dolu değil!");

  loginModal.style.display="none";
  roomModal.style.display="flex";

  listenRooms();
}

// Rooms
function listenRooms(){
  const roomsRef = ref(db,"game/rooms");
  onValue(roomsRef,snap=>{
    roomsListDiv.innerHTML="";
    const data = snap.val()||{};
    for(const rId in data){
      const div = document.createElement("div");
      div.className="roomItem";
      div.textContent=`${rId} | Level ${data[rId].level || 1}`;
      div.onclick=()=>joinRoom(rId);
      roomsListDiv.appendChild(div);
    }
  });
}

document.getElementById("createRoomBtn").onclick = ()=>{
  const newRoomId = "room"+Math.floor(Math.random()*10000);
  const level = prompt("Level seç (1-5)","1");
  set(ref(db,"game/rooms/"+newRoomId),{
    host: username,
    level: parseInt(level),
    players:{}
  });
  joinRoom(newRoomId);
}

function joinRoom(rId){
  roomId=rId;
  const playerRef = ref(db,"game/rooms/"+roomId+"/players/"+username);
  set(playerRef,{x:50,y:50,nickname,avatar});
  roomModal.style.display="none";
  gameLoop();
  listenRoomPlayers();
  listenRoomScores();
}

// Movement
window.addEventListener("keydown",e=>{ keys[e.key]=true; });
window.addEventListener("keyup",e=>{ keys[e.key]=false; });

function movePlayer(){
  if(!username || !roomId) return;
  const p = players[username];
  if(!p) return;
  let speed=2;
  if(keys["ArrowUp"]||keys["w"]) p.y-=speed;
  if(keys["ArrowDown"]||keys["s"]) p.y+=speed;
  if(keys["ArrowLeft"]||keys["a"]) p.x-=speed;
  if(keys["ArrowRight"]||keys["d"]) p.x+=speed;
  p.x=Math.max(0,Math.min(canvas.width-20,p.x));
  p.y=Math.max(0,Math.min(canvas.height-20,p.y));
  set(ref(db,"game/rooms/"+roomId+"/players/"+username),p);
}

// Listen players
function listenRoomPlayers(){
  const roomPlayersRef = ref(db,"game/rooms/"+roomId+"/players");
  onValue(roomPlayersRef,snap=>{
    players = snap.val()||{};
    drawGame();
  });
}

// Listen scores
function listenRoomScores(){
  const roomScoresRef = ref(db,"game/rooms/"+roomId+"/scores");
  onValue(roomScoresRef,snap=>{
    scores = snap.val()||{};
    updateLeaderboard();
  });
}

// Draw
function drawGame(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(const id in players){
    const pl = players[id];
    ctx.fillStyle=(id===username)?"#7289da":"#43b581";
    ctx.fillRect(pl.x,pl.y,20,20);
    ctx.fillStyle="white";
    ctx.fillText(pl.nickname,pl.x,pl.y-5);
  }
}

// Score demo
let score=0;
function updateScore(){
  if(!username || !roomId) return;
  score+=1;
  set(ref(db,"game/rooms/"+roomId+"/scores/"+username),{nickname,score});
  updateLeaderboard();
}

// Leaderboard
function updateLeaderboard(){
  leaderboardUl.innerHTML="";
  const sorted = Object.entries(scores).sort((a,b)=>b[1].score - a[1].score);
  sorted.forEach(([u,v])=>{
    const li = document.createElement("li");
    li.textContent=`${v.nickname}: ${v.score}`;
    leaderboardUl.appendChild(li);
  });
}

// Game loop
function gameLoop(){
  movePlayer();
  drawGame();
  updateScore();
  requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>
